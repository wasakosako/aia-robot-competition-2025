# 設計書

## 1. システム設計概要

### 1.1 システムアーキテクチャ

```
┌─────────────────────────────────────────────────────────────┐
│                    リモートPC                                │
├─────────────────────────────────────────────────────────────┤
│  ┌───────────────┐  ┌───────────────┐  ┌───────────────┐  │
│  │  戦略エンジン  │  │  UI/監視画面  │  │  通信マネージャ │  │
│  └───────────────┘  └───────────────┘  └───────────────┘  │
│  ┌───────────────┐  ┌───────────────┐  ┌───────────────┐  │
│  │  画像処理     │  │  地図管理     │  │  ログ管理     │  │
│  └───────────────┘  └───────────────┘  └───────────────┘  │
└─────────────────────────────────────────────────────────────┘
                              │ WiFi通信
                              ▼
┌─────────────────────────────────────────────────────────────┐
│                     ロボット本体                            │
├─────────────────────────────────────────────────────────────┤
│  ┌───────────────┐  ┌───────────────┐  ┌───────────────┐  │
│  │  メイン制御   │  │  ナビゲーション│  │  アクション実行│  │
│  └───────────────┘  └───────────────┘  └───────────────┘  │
│  ┌───────────────┐  ┌───────────────┐  ┌───────────────┐  │
│  │  センサー管理 │  │  通信クライアント│  │  モーター制御 │  │
│  └───────────────┘  └───────────────┘  └───────────────┘  │
│  ┌───────────────┐  ┌───────────────┐  ┌───────────────┐  │
│  │  LiDAR       │  │  カメラ       │  │  IMU/エンコーダ│  │
│  └───────────────┘  └───────────────┘  └───────────────┘  │
└─────────────────────────────────────────────────────────────┘
```

### 1.2 設計方針

#### 1.2.1 モジュール化設計
- 機能ごとに独立したモジュール設計
- インターフェースの標準化
- テスト容易性の確保

#### 1.2.2 リアルタイム性
- 制御ループ：50Hz以上
- センサーデータ処理：100Hz以上
- 通信遅延の最小化

#### 1.2.3 拡張性
- 新しいセンサーの追加が容易
- 戦略アルゴリズムの変更が容易
- パラメータ調整が容易

## 2. ハードウェア設計

### 2.1 ロボット本体設計

#### 2.1.1 基本構成
- **ベース**: ライトローバー（ヴィストン社製）
- **サイズ**: スタートエリア（50cm幅）に収まる設計
- **重量**: バランスを考慮した重心設計

#### 2.1.2 センサー配置

```
     [前方カメラ]  
         ↑
    ┌──────────────┐
    │  ┌─────┐   │  [LiDAR]
    │  │     │   │     ↑
    │  │ PC  │   │  ┌─────┐
    │  │     │   │  │  ○  │
    │  └─────┘   │  └─────┘
    │             │
    │   [バッテリー] │
    │             │
    │ [モーター]   │
    │  ○     ○   │
    └──────────────┘
      前輪   後輪
```

#### 2.1.3 アタッチメント設計

**標的押し出し機構**
- **形状**: 楕円状の押し出し板
- **材質**: 軽量かつ耐久性のある樹脂
- **取り付け**: ボルト固定（振動に強い）
- **サイズ**: 標的を確実に押し出せる幅

**保護機構**
- **前方バンパー**: 衝突時の衝撃吸収
- **側面ガード**: 横からの接触保護
- **上部カバー**: 部品保護

### 2.2 電装系設計

#### 2.2.1 電源系統
- **主電源**: 充電式リチウムイオン電池
- **バックアップ**: 単3乾電池×8本
- **電源管理**: 自動切替機能
- **稼働時間**: 連続3時間以上

#### 2.2.2 通信系統
- **WiFiモジュール**: 5GHz帯対応
- **アンテナ**: 指向性アンテナ（リモートPC方向）
- **通信範囲**: 競技エリア全域
- **データレート**: 最低1Mbps確保

### 2.3 リモートPC設計

#### 2.3.1 ハードウェア仕様
- **CPU**: Intel Core i7以上 / AMD Ryzen 7以上
- **メモリ**: 16GB以上
- **GPU**: NVIDIA GeForce GTX 1060以上（画像処理用）
- **ストレージ**: SSD 500GB以上
- **通信**: WiFi 6対応

#### 2.3.2 周辺機器
- **外部カメラ**: 4K対応USBカメラ（上部設置用）
- **モニター**: デュアルディスプレイ構成
- **入力装置**: キーボード、マウス
- **無停電電源**: UPS（緊急時対応）

## 3. ソフトウェア設計

### 3.1 システム構成

```
┌─────────────────────────────────────────────────────────────┐
│                     アプリケーション層                      │
├─────────────────────────────────────────────────────────────┤
│ ┌─────────────┐ ┌─────────────┐ ┌─────────────┐ ┌─────────┐ │
│ │ 戦略制御    │ │ UI制御      │ │ ログ管理    │ │ 設定管理│ │
│ └─────────────┘ └─────────────┘ └─────────────┘ └─────────┘ │
├─────────────────────────────────────────────────────────────┤
│                     ミドルウェア層                          │
├─────────────────────────────────────────────────────────────┤
│ ┌─────────────┐ ┌─────────────┐ ┌─────────────┐ ┌─────────┐ │
│ │ 画像処理    │ │ 経路計画    │ │ 通信制御    │ │ 地図管理│ │
│ └─────────────┘ └─────────────┘ └─────────────┘ └─────────┘ │
├─────────────────────────────────────────────────────────────┤
│                     ハードウェア制御層                      │
├─────────────────────────────────────────────────────────────┤
│ ┌─────────────┐ ┌─────────────┐ ┌─────────────┐ ┌─────────┐ │
│ │ モーター制御│ │ センサー管理│ │ 通信ドライバ│ │ I/O制御 │ │
│ └─────────────┘ └─────────────┘ └─────────────┘ └─────────┘ │
└─────────────────────────────────────────────────────────────┘
```

### 3.2 主要モジュール設計

#### 3.2.1 メイン制御モジュール

**クラス図**
```python
class MainController:
    def __init__(self)
    def start_competition(self)
    def update_status(self)
    def handle_restart(self)
    def emergency_stop(self)
    def shutdown(self)

class GameState:
    def __init__(self)
    def update_targets(self)
    def update_obstacles(self)
    def calculate_score(self)
    def is_game_finished(self)
```

**状態遷移図**
```
[初期化] → [待機] → [競技開始] → [標的探索] → [標的獲得] → [ゴール] → [終了]
    ↓         ↓         ↓           ↓           ↓         ↓
  [エラー] ← [エラー] ← [エラー] ← [エラー] ← [エラー] ← [エラー]
                                    ↓
                                [リスタート] → [標的探索]
```

#### 3.2.2 ナビゲーションモジュール

**アルゴリズム**
- **SLAM**: LiDARとカメラを用いた地図構築・自己位置推定
- **経路計画**: A*アルゴリズム + 動的経路補正
- **障害物回避**: Dynamic Window Approach (DWA)
- **位置制御**: PID制御

#### 3.2.3 画像処理モジュール

**処理フロー**
```
[画像取得] → [前処理] → [物体検出] → [物体追跡] → [位置推定] → [制御指令]
```

**検出対象**
- 標的（色・形状による識別）
- 障壁（サイズ・形状による識別）
- 相手ロボット（動きによる識別）
- 競技エリア境界（ライン検出）

#### 3.2.4 戦略エンジンモジュール

**戦略アルゴリズム**
```python
class StrategyEngine:
    def __init__(self)
    def analyze_game_state(self, game_state)
    def select_strategy(self, analysis_result)
    def execute_strategy(self, strategy)
    def adapt_strategy(self, feedback)

class StrategyType(Enum):
    AGGRESSIVE = "aggressive"      # 積極的攻撃戦略
    DEFENSIVE = "defensive"        # 守備的戦略
    BALANCED = "balanced"          # バランス戦略
    ENDGAME = "endgame"           # 終盤戦略
```

## 4. ユーザーインターフェース設計

### 4.1 メイン画面構成

```
┌─────────────────────────────────────────────────────────────┐
│ [AiA Robot Competition 2025]  [00:02:45] [SCORE: 4-2]      │
├─────────────────────────────────────────────────────────────┤
│  ┌───────────────────────┐  ┌─────────────────────────────┐  │
│  │                       │  │  Robot Status               │  │
│  │                       │  │  ┌─────────────────────────┐ │  │
│  │       Field Map       │  │  │ Position: (120, 85)     │ │  │
│  │                       │  │  │ Battery: 85%            │ │  │
│  │     [R] ●○○  ○○○ [O]   │  │  │ Status: Moving          │ │  │
│  │         ●■○  ○■○       │  │  │ Speed: 0.5 m/s          │ │  │
│  │         ●○○  ○○○       │  │  └─────────────────────────┘ │  │
│  │                       │  │                             │  │
│  └───────────────────────┘  │  Strategy: AGGRESSIVE       │  │
├─────────────────────────────┼─────────────────────────────┤
│  Control Panel              │  System Log                 │
│  ┌─────────────────────────┐ │  ┌─────────────────────────┐ │
│  │ [START] [STOP] [RESET]  │ │  │ 12:34:56 Target detected│ │
│  │                         │ │  │ 12:34:57 Moving to Area1│ │
│  │ Emergency Stop          │ │  │ 12:34:58 Target acquired│ │
│  │ [ EMERGENCY STOP ]      │ │  │ 12:34:59 Heading to goal│ │
│  └─────────────────────────┘ │  └─────────────────────────┘ │
└─────────────────────────────────────────────────────────────┘
```

### 4.2 画面仕様

#### 4.2.1 フィールドマップ表示
- **描画要素**:
  - 競技エリア境界
  - 自ロボット位置（R）
  - 相手ロボット位置（O）
  - 標的（●）
  - 障壁（■）
  - 計画経路（点線）
  - リアルタイム軌跡

#### 4.2.2 ステータス表示
- **ロボット状態**:
  - 現在位置座標
  - バッテリー残量
  - 動作状態
  - 移動速度
  - センサー状態

#### 4.2.3 制御パネル
- **基本制御**:
  - 競技開始ボタン
  - 緊急停止ボタン
  - リスタートボタン
  - 戦略変更

## 5. テスト設計

### 5.1 テスト戦略

#### 5.1.1 テストレベル
1. **単体テスト**: 各モジュールの個別テスト
2. **統合テスト**: モジュール間連携テスト
3. **システムテスト**: システム全体の動作テスト
4. **実機テスト**: 実際の競技環境でのテスト

#### 5.1.2 テスト環境
- **シミュレーション環境**: Gazebo + ROS
- **実機テスト環境**: 競技フィールド再現
- **単体テスト環境**: pytest + mock

### 5.2 テストケース設計

#### 5.2.1 ナビゲーションテスト
```python
class TestNavigation:
    def test_path_planning_simple(self):
        # 障害物なし環境での経路計画テスト
        pass
        
    def test_path_planning_with_obstacles(self):
        # 障害物あり環境での経路計画テスト
        pass
        
    def test_obstacle_avoidance(self):
        # 動的障害物回避テスト
        pass
        
    def test_position_control_accuracy(self):
        # 位置制御精度テスト
        pass
```

#### 5.2.2 画像処理テスト
```python
class TestVision:
    def test_target_detection_accuracy(self):
        # 標的検出精度テスト
        pass
        
    def test_detection_under_different_lighting(self):
        # 照明条件変化での検出テスト
        pass
        
    def test_false_positive_rate(self):
        # 誤検出率テスト
        pass
```

#### 5.2.3 統合テスト
```python
class TestIntegration:
    def test_full_competition_scenario(self):
        # 完全な競技シナリオテスト
        pass
        
    def test_communication_failure_recovery(self):
        # 通信障害からの復旧テスト
        pass
        
    def test_sensor_failure_handling(self):
        # センサー障害対応テスト
        pass
```

## 6. デプロイメント設計

### 6.1 ソフトウェア配布

#### 6.1.1 パッケージ構成
```
aia-robot-system/
├── robot/              # ロボット側プログラム
│   ├── main.py
│   ├── navigation/
│   ├── vision/
│   └── communication/
├── remote/             # リモートPC側プログラム
│   ├── main.py
│   ├── strategy/
│   ├── ui/
│   └── monitoring/
├── config/             # 設定ファイル
├── tests/              # テストコード
└── docs/               # ドキュメント
```

#### 6.1.2 インストール手順
1. 依存関係のインストール
2. 設定ファイルの調整
3. カメラ・センサーのキャリブレーション
4. 通信テスト
5. 動作確認テスト

### 6.2 運用手順

#### 6.2.1 競技当日の準備
1. ハードウェア点検
2. ソフトウェア動作確認
3. レギュレーション検査
4. 試走での最終調整

#### 6.2.2 競技中の運用
1. システム起動
2. 初期化・キャリブレーション
3. 戦略選択
4. 競技実行
5. 緊急時対応

## 7. 保守・拡張設計

### 7.1 保守性
- **モジュール化**: 独立したモジュール設計
- **設定外部化**: YAML設定ファイル
- **ログ機能**: 詳細なログ出力
- **エラーハンドリング**: 包括的な例外処理

### 7.2 拡張性
- **センサー追加**: プラグイン方式でのセンサー追加
- **戦略追加**: 戦略パターンの追加が容易
- **UI改善**: モジュール化されたUI設計
- **通信プロトコル拡張**: 新しい通信方式への対応

### 7.3 パフォーマンス最適化
- **処理の並列化**: マルチスレッド・マルチプロセス
- **メモリ最適化**: 効率的なデータ構造
- **通信最適化**: データ圧縮・キャッシュ
- **リアルタイム性**: 優先度制御・スケジューリング

## 8. セキュリティ設計

### 8.1 通信セキュリティ
- **暗号化**: TLS/SSL通信
- **認証**: 接続認証機能
- **アクセス制御**: IP制限・ポート制限

### 8.2 データ保護
- **ログ暗号化**: 機密データの保護
- **設定ファイル保護**: 改ざん検知
- **メモリ保護**: デバッグ情報の制限

### 8.3 システム保護
- **入力検証**: 不正データの検証
- **リソース制限**: DoS攻撃対策
- **監査ログ**: セキュリティイベントの記録
